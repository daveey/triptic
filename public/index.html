<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1080, height=1920">
    <title>Triptic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
        }
        #display {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-family: sans-serif;
            font-size: 24px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f44;
            font-family: sans-serif;
            font-size: 18px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <img id="display" alt="Display">
    <div id="loading">Loading...</div>
    <div id="error"></div>

    <script>
        (function() {
            // Configuration
            var IMAGE_COUNT = 6;
            var POLL_INTERVAL = 500; // ms - poll for changes frequently
            var FREQUENCY_SECONDS = 60; // Default frequency in seconds
            var isPolling = false; // Prevent concurrent poll requests

            // Helper function for old browsers without URLSearchParams
            function getUrlParam(name) {
                var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
                return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
            }

            // State
            // Check for ?id=X parameter, fallback to hash, or redirect to dashboard
            var screenId = getUrlParam('id') || document.URL.split("#")[1] || "";

            // If no screen ID specified, redirect to dashboard
            if (!screenId) {
                window.location.href = '/dashboard.html';
            }
            var imageUrls = [];
            var thumbUrls = []; // Thumbnail URLs for faster initial loading
            var images = [];
            var preloadedImages = {}; // Cache of preloaded Image objects by URL
            var preloadedThumbs = {}; // Cache of preloaded thumbnail objects
            var numImagesLoaded = 0;
            var loadingComplete = false;
            var currentImageIndex = -1;
            var currentDisplayedUrl = null; // Track what's currently shown
            var currentIsThumb = false; // Track if currently showing thumbnail
            var updateInterval = null;

            // DOM elements
            var displayEl = document.getElementById('display');
            var loadingEl = document.getElementById('loading');
            var errorEl = document.getElementById('error');

            function getBaseUrl(url) {
                // Strip cache buster to compare base URLs
                return url ? url.split('?')[0] : '';
            }

            function buildImageUrls(playlistItems) {
                var newUrls = [];
                var newThumbs = [];
                if (playlistItems && playlistItems.length > 0) {
                    // Load from playlist - no cache buster, we use preloading
                    for (var i = 0; i < playlistItems.length; i++) {
                        var item = playlistItems[i];
                        var url = item[screenId] || item['center'] || '';
                        var thumbKey = screenId + '_thumb';
                        var thumbUrl = item[thumbKey] || item['center_thumb'] || url;
                        if (url) {
                            newUrls.push(url);
                            newThumbs.push(thumbUrl);
                        }
                    }
                } else {
                    // Fallback to old behavior
                    var basePath = screenId ? 'img/' + screenId + '/' : 'img/';
                    var ext = getUrlParam('ext') || 'svg';
                    for (var j = 1; j <= IMAGE_COUNT; j++) {
                        newUrls.push(basePath + j + '.' + ext);
                        newThumbs.push(basePath + j + '.' + ext);
                    }
                }
                thumbUrls = newThumbs;
                return newUrls;
            }

            function preloadImage(url, callback) {
                // Check if already preloaded
                if (preloadedImages[url]) {
                    if (callback) callback(preloadedImages[url]);
                    return;
                }

                var img = new Image();
                img.onload = function() {
                    preloadedImages[url] = img;
                    if (callback) callback(img);
                };
                img.onerror = function() {
                    if (console && console.warn) console.warn('Failed to preload image:', url);
                    // Still cache it to avoid repeated failed requests
                    preloadedImages[url] = img;
                    if (callback) callback(img);
                };
                // Add cache buster for fresh fetch
                img.src = url + '?v=' + Date.now();
            }

            function preloadImagesSequentially(urls, startIndex, callback) {
                // Preload images one at a time, starting from startIndex and wrapping around
                var total = urls.length;
                if (total === 0) {
                    if (callback) callback();
                    return;
                }

                var loaded = 0;
                var currentIdx = startIndex;

                function loadNext() {
                    if (loaded >= total) {
                        if (callback) callback();
                        return;
                    }

                    var url = urls[currentIdx];
                    preloadImage(url, function() {
                        loaded++;
                        if (loadingEl && loadingEl.style.display !== 'none') {
                            loadingEl.textContent = 'Loading... ' + loaded + '/' + total;
                        }
                        // Move to next index, wrapping around
                        currentIdx = (currentIdx + 1) % total;
                        loadNext();
                    });
                }

                loadNext();
            }

            function loadImages() {
                // Progressive loading: load current thumbnail first, then display
                numImagesLoaded = 0;
                var startIndex = getCurrentImageIndex();

                // First, load current thumbnail immediately
                var currentThumb = thumbUrls[startIndex];
                if (currentThumb) {
                    preloadImage(currentThumb, function() {
                        preloadedThumbs[currentThumb] = preloadedImages[currentThumb];
                        loadingComplete = true;
                        if (loadingEl) loadingEl.style.display = 'none';
                        displayImage();
                        startUpdateTimer();

                        // Then load current full image
                        var currentFull = imageUrls[startIndex];
                        preloadImage(currentFull, function() {
                            // Swap to full if still showing thumb
                            if (currentIsThumb && currentImageIndex === startIndex) {
                                setBackground(currentFull);
                                currentIsThumb = false;
                            }

                            // Then preload remaining thumbs sequentially (starting from next)
                            var nextIndex = (startIndex + 1) % thumbUrls.length;
                            preloadImagesSequentially(thumbUrls, nextIndex, function() {
                                // Copy all thumbs to cache
                                for (var i = 0; i < thumbUrls.length; i++) {
                                    if (preloadedImages[thumbUrls[i]]) {
                                        preloadedThumbs[thumbUrls[i]] = preloadedImages[thumbUrls[i]];
                                    }
                                }
                                if (console && console.log) console.log('[LOAD] All thumbnails preloaded');

                                // Finally preload remaining full images sequentially
                                preloadImagesSequentially(imageUrls, nextIndex, function() {
                                    if (console && console.log) console.log('[LOAD] All full images preloaded');
                                });
                            });
                        });
                    });
                } else {
                    // Fallback if no thumbs
                    loadingComplete = true;
                    if (loadingEl) loadingEl.style.display = 'none';
                    displayImage();
                    startUpdateTimer();
                }
            }

            function getCurrentImageIndex() {
                var imageCount = imageUrls.length || IMAGE_COUNT;
                var now = new Date();
                var totalSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
                var cycleNumber = Math.floor(totalSeconds / FREQUENCY_SECONDS);
                return cycleNumber % imageCount;
            }

            function displayImage() {
                var index = getCurrentImageIndex();
                var fullUrl = imageUrls[index];
                var thumbUrl = thumbUrls[index];

                if (!fullUrl) return;

                // Only update if URL actually changed
                if (fullUrl !== currentDisplayedUrl || (currentIsThumb && preloadedImages[fullUrl])) {
                    currentImageIndex = index;

                    // Check if full image is already preloaded
                    if (preloadedImages[fullUrl]) {
                        // Full image ready, show it
                        currentDisplayedUrl = fullUrl;
                        currentIsThumb = false;
                        setBackground(fullUrl);
                    } else if (thumbUrl && (preloadedThumbs[thumbUrl] || preloadedImages[thumbUrl])) {
                        // Show thumbnail while full loads
                        currentDisplayedUrl = fullUrl;
                        currentIsThumb = true;
                        setBackground(thumbUrl);

                        // Preload full image and swap when ready
                        preloadImage(fullUrl, function() {
                            // Only swap if we're still on the same image
                            if (currentDisplayedUrl === fullUrl && currentIsThumb) {
                                setBackground(fullUrl);
                                currentIsThumb = false;
                            }
                        });
                    } else {
                        // No preload available, just load full
                        currentDisplayedUrl = fullUrl;
                        currentIsThumb = false;
                        setBackground(fullUrl);
                    }
                }
            }

            function setBackground(baseUrl) {
                // Use preloaded image if available, otherwise load with cache buster
                var img = preloadedImages[baseUrl];
                if (img && img.src) {
                    displayEl.src = img.src;
                } else {
                    displayEl.src = baseUrl + '?v=' + Date.now();
                }
            }

            var currentPlaylistName = null;
            var currentPlaylistItems = null; // Store full playlist items for comparison

            function loadConfig() {
                if (console && console.log) console.log('[DEBUG] loadConfig() called');

                // Use XMLHttpRequest for old browser compatibility
                var configLoaded = false;
                var playlistLoaded = false;
                var config = {};
                var playlist = {};

                function checkBothLoaded() {
                    if (configLoaded && playlistLoaded) {
                        if (console && console.log) console.log('[DEBUG] Config and playlist loaded:', config, playlist);

                        if (config.frequency) {
                            FREQUENCY_SECONDS = config.frequency;
                            if (console && console.log) console.log('Loaded frequency:', FREQUENCY_SECONDS, 'seconds');
                        }

                        if (playlist.items) {
                            if (console && console.log) console.log('Loaded playlist:', playlist.name, 'with', playlist.items.length, 'items');
                            currentPlaylistName = playlist.name;
                            currentPlaylistItems = playlist.items;
                            if (console && console.log) console.log('[DEBUG] Set currentPlaylistName to:', currentPlaylistName);
                            imageUrls = buildImageUrls(playlist.items);
                            if (console && console.log) console.log('[DEBUG] Built imageUrls:', imageUrls.length, 'items');
                            loadImages();
                        } else {
                            // Fallback
                            imageUrls = buildImageUrls(null);
                            loadImages();
                        }
                    }
                }

                var configXhr = new XMLHttpRequest();
                configXhr.open('GET', '/config', true);
                configXhr.onreadystatechange = function() {
                    if (configXhr.readyState === 4) {
                        if (configXhr.status === 200) {
                            try {
                                config = JSON.parse(configXhr.responseText);
                            } catch (e) {
                                if (console && console.warn) console.warn('Failed to parse config:', e);
                            }
                        }
                        configLoaded = true;
                        checkBothLoaded();
                    }
                };
                configXhr.send();

                var playlistXhr = new XMLHttpRequest();
                playlistXhr.open('GET', '/playlist', true);
                playlistXhr.onreadystatechange = function() {
                    if (playlistXhr.readyState === 4) {
                        if (playlistXhr.status === 200) {
                            try {
                                playlist = JSON.parse(playlistXhr.responseText);
                            } catch (e) {
                                if (console && console.warn) console.warn('Failed to parse playlist:', e);
                            }
                        }
                        playlistLoaded = true;
                        checkBothLoaded();
                    }
                };
                playlistXhr.send();
            }

            function checkForChanges() {
                // Skip if already polling (limit to 1 outstanding request)
                if (isPolling) return;
                isPolling = true;

                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/playlist', true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        isPolling = false; // Clear flag when request completes

                        if (xhr.status === 200) {
                            try {
                                var playlist = JSON.parse(xhr.responseText);

                                // Check for playlist name change
                                if (playlist.name !== currentPlaylistName) {
                                    if (console && console.log) console.log('Playlist changed from', currentPlaylistName, 'to', playlist.name, '- reloading');
                                    location.reload(true);
                                    return;
                                }

                                // Check for URL changes in current playlist items (flips!)
                                if (playlist.items && playlist.items.length > 0) {
                                    var newUrls = buildImageUrls(playlist.items);
                                    var newThumbs = thumbUrls.slice(); // Save current thumbs built by buildImageUrls
                                    var currentIndex = getCurrentImageIndex();
                                    var currentExpectedUrl = newUrls[currentIndex];
                                    var currentExpectedThumb = newThumbs[currentIndex];
                                    var oldUrl = imageUrls[currentIndex];

                                    // Check if the URL for the current index changed
                                    if (oldUrl && currentExpectedUrl && getBaseUrl(oldUrl) !== getBaseUrl(currentExpectedUrl)) {
                                        if (console && console.log) console.log('[FLIP] Image URL changed at index', currentIndex);
                                        if (console && console.log) console.log('[FLIP] Old:', oldUrl, '-> New:', currentExpectedUrl);

                                        // Preload the thumbnail first, then full image
                                        preloadImage(currentExpectedThumb, function() {
                                            // Show thumb immediately
                                            preloadedThumbs[currentExpectedThumb] = preloadedImages[currentExpectedThumb];
                                            imageUrls = newUrls;
                                            currentPlaylistItems = playlist.items;
                                            currentDisplayedUrl = null;
                                            displayImage();

                                            // Then preload full image
                                            preloadImage(currentExpectedUrl, function() {
                                                if (console && console.log) console.log('[FLIP] Full image preloaded');
                                                // Swap to full if still showing thumb
                                                if (currentIsThumb && currentDisplayedUrl === currentExpectedUrl) {
                                                    setBackground(currentExpectedUrl);
                                                    currentIsThumb = false;
                                                }
                                            });
                                        });
                                    } else {
                                        // No change at current index, but update the full list
                                        // in case other indices changed
                                        var anyChanged = false;
                                        for (var i = 0; i < newUrls.length; i++) {
                                            if (getBaseUrl(imageUrls[i]) !== getBaseUrl(newUrls[i])) {
                                                anyChanged = true;
                                                // Preload changed thumb and image in background
                                                preloadImage(newThumbs[i], null);
                                                preloadImage(newUrls[i], null);
                                            }
                                        }
                                        if (anyChanged) {
                                            imageUrls = newUrls;
                                            currentPlaylistItems = playlist.items;
                                        }
                                    }
                                }
                            } catch (e) {
                                if (console && console.warn) console.warn('Failed to parse playlist:', e);
                            }
                        }
                    }
                };
                xhr.send();
            }

            function sendHeartbeat() {
                if (!screenId) return; // Don't send heartbeat if no screen ID

                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/heartbeat/' + screenId, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send();
            }

            function startUpdateTimer() {
                // Send initial heartbeat
                sendHeartbeat();

                // Check for image updates every second
                updateInterval = setInterval(function() {
                    displayImage();
                }, 1000);

                // Send heartbeat every minute
                setInterval(sendHeartbeat, 60000);

                // Poll for playlist changes
                setInterval(checkForChanges, POLL_INTERVAL);
            }

            // Listen for messages from parent (wall.html) to jump to specific asset group
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'jumpToAssetGroup') {
                    var targetAssetGroup = event.data.asset_group;
                    if (console && console.log) console.log('[DEBUG] Received jumpToAssetGroup message:', targetAssetGroup);

                    // Find the index of this asset group in our imageUrls array
                    var targetIndex = -1;
                    for (var i = 0; i < imageUrls.length; i++) {
                        if (imageUrls[i].indexOf(targetAssetGroup) !== -1) {
                            targetIndex = i;
                            break;
                        }
                    }

                    if (targetIndex >= 0) {
                        if (console && console.log) console.log('[DEBUG] Found asset group at index:', targetIndex);
                        currentImageIndex = targetIndex;
                        currentDisplayedUrl = imageUrls[targetIndex];
                        setBackground(imageUrls[targetIndex]);
                    } else {
                        if (console && console.warn) console.warn('[DEBUG] Could not find asset group in imageUrls:', targetAssetGroup);
                    }
                }
            });

            function onLoad() {
                loadConfig();

                // Fallback polling in case images never load (timeout after 30s)
                setTimeout(function() {
                    if (!loadingComplete) {
                        loadingEl.style.display = 'none';
                        // Silently proceed - don't show error on display screens
                        loadingComplete = true;
                        displayImage();
                        startUpdateTimer();
                    }
                }, 30000);
            }

            // Start the application
            window.onload = onLoad;
        })();
    </script>
</body>
</html>
